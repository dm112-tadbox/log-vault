{"version":3,"file":"index1.js","names":["_winston","require","_winston2","_interopRequireDefault","_path","_path2","_config","_config2","_ip","_ip2","_graylog_http","_graylog_http2","_mongodb","_mongodb2","obj","__esModule","default","combine","timestamp","printf","winston","format","logPath","path","resolve","__dirname","config","log","folder","logPathCombined","logPathError","logPathFile","logPathErrorFile","auditFile","levels","error","warn","info","http","colors","addColors","myFormat","level","message","output","stack","details","JSON","stringify","transports","Console","consoleLogLevel","colorize","simple","file","push","DailyRotateFile","filename","prettyPrint","datePattern","maxSize","fileMaxSize","maxFiles","storagePeriod","graylog","graylogHttp","mongo","mongoTransport","logger","createLogger","write","exports","Error","Object","keys","includes","args","options","data","app","projectName","env","process","NODE_ENV","server_ip","ip","address","Date","realmId","realm","userId","profile","header","service","method","capture","console","main","arguments","values","entries","map","i","strings","filter","v","join","forEach","npm_package_name","length"],"sources":["../src/index1.js"],"sourcesContent":["import winston from \"winston\";\nimport \"winston-daily-rotate-file\";\nimport path from \"path\";\nimport config from \"@lib/config\";\nimport ip from \"ip\";\nimport graylogHttp from \"./transports/graylog_http\";\nimport mongoTransport from \"./transports/mongodb\";\n\nconst { combine, timestamp, printf } = winston.format;\n\nconst logPath = path.resolve(\n  __dirname,\n  config.log.folder === \"internal\" ? \"../../../logs\" : \"../../../../logs\"\n);\nconst logPathCombined = path.resolve(logPath, \"combined\");\nconst logPathError = path.resolve(logPath, \"error\");\nconst logPathFile = path.resolve(logPathCombined, \"combined-%DATE%.log\");\nconst logPathErrorFile = path.resolve(logPathError, \"error-%DATE%.log\");\nconst auditFile = path.resolve(logPath, \"audit\");\n\nconst levels = {\n  error: 0,\n  warn: 1,\n  info: 2,\n  http: 3\n};\n\nconst colors = {\n  error: \"white redBG\",\n  warn: \"white magentaBG\",\n  info: \"white greenBG\",\n  http: \"white cyanBG\"\n};\nwinston.addColors(colors);\n\nconst myFormat = printf(({ level, message, timestamp }) => {\n  let output = `\\t${timestamp} ${level} ${message.message}`;\n\n  if (message.stack) output += `\\n ${message.stack}`;\n  if (message.details)\n    output += `:\\n${JSON.stringify(message.details, null, 2)}`;\n  return output;\n});\n\nconst transports = [\n  new winston.transports.Console({\n    level: config.log.consoleLogLevel || \"http\",\n    format: winston.format.combine(\n      timestamp(),\n      winston.format.colorize(),\n      winston.format.simple(),\n      myFormat\n    )\n  })\n];\nif (config.log.transports) {\n  if (config.log.transports.file)\n    transports.push(\n      new winston.transports.DailyRotateFile({\n        filename: logPathFile,\n        level: \"http\",\n        format: combine(timestamp(), winston.format.prettyPrint()),\n        auditFile,\n        datePattern: \"YYYY-MM-DD\",\n        maxSize: config.log.fileMaxSize,\n        maxFiles: config.log.storagePeriod\n      }),\n      new winston.transports.DailyRotateFile({\n        filename: logPathErrorFile,\n        level: \"error\",\n        format: combine(timestamp(), winston.format.prettyPrint()),\n        auditFile,\n        datePattern: \"YYYY-MM-DD\",\n        maxSize: config.log.fileMaxSize,\n        maxFiles: config.log.storagePeriod\n      })\n    );\n\n  if (config.log.transports.graylog) transports.push(new graylogHttp());\n  if (config.log.transports.mongo)\n    transports.push(new mongoTransport({ level: \"http\" }));\n}\n\nconst logger = winston.createLogger({ transports, levels, level: \"info\" });\n\nexport const write = function (message) {\n  if (!message) throw new Error(\"Log message object is missing\");\n  if (typeof message !== \"object\")\n    throw new Error(\"Message should be of object type\");\n  const level = message.level || \"info\";\n  if (!Object.keys(levels).includes(level))\n    throw new Error(`Unaccessible log level: ${level}`);\n  logger.log({\n    level,\n    message\n  });\n};\n\nexport const log = async function (message, args, options) {\n  const data = {\n    app: config.projectName,\n    env: process.env.NODE_ENV,\n    message,\n    level: \"info\",\n    server_ip: ip.address(),\n    timestamp: new Date()\n  };\n\n  if (args && args[1]) {\n    if (args[1].realmId) data.realm = args[1].realmId;\n    if (args[1].userId) data.profile = args[1].userId;\n    if (args[1].header) {\n      if (args[1].header.service) data.process = args[1].header.service;\n      if (args[1].header.method) data.method = args[1].header.method;\n    }\n  }\n\n  if (options) {\n    if (options.level) data.level = options.level;\n    if (options.details) data.details = options.details;\n    if (options.stack) data.stack = options.stack;\n    if (options.process) data.process = options.process;\n    if (options.realm) data.realm = options.realm;\n    if (options.profile) data.profile = options.profile;\n    if (options.method) data.method = options.method;\n  }\n\n  write(data);\n};\n\nexport const capture = function () {\n  if (!config.log.capture) {\n    return;\n  }\n  console.log = function () {\n    return main(arguments, \"info\");\n  };\n  console.error = function () {\n    return main(arguments, \"error\");\n  };\n  console.warn = function () {\n    return main(arguments, \"warn\");\n  };\n  function main(args, level) {\n    const values = Object.entries(args).map((i) => {\n      return i[1];\n    });\n    const strings = values\n      .filter((v) => {\n        return typeof v !== \"object\";\n      })\n      .join(\", \");\n    const details = [];\n    values\n      .filter((v) => {\n        return typeof v === \"object\";\n      })\n      .forEach((obj) => {\n        details.push(obj);\n      });\n    const data = {\n      level,\n      process: process.env.npm_package_name\n    };\n    if (details.length) data.details = details;\n    log(strings, null, data);\n  }\n};\n"],"mappings":"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"}